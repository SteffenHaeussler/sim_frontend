<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/app.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/ask-agent.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/lookup-service.css') }}">
</head>
<body>
    <div class="app-layout">
        {% include "sidebar.html" %}

        <div class="main-area">
            <div class="container">
                {% include "ask-agent.html" %}
                {% include "lookup-service.html" %}
            </div>
        </div>

        {% include "input-area.html" %}
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Login</h2>
                <span class="close" id="close-login-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form autocomplete="on">
                    <div class="form-group">
                        <label for="login-email">Email:</label>
                        <input type="email" id="login-email" name="email" placeholder="Enter your email" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password:</label>
                        <input type="password" id="login-password" name="password" placeholder="Enter your password" required autocomplete="current-password">
                    </div>
                    <button type="button" id="login-submit" class="btn-primary">Login</button>
                    <div class="register-link">
                        <a href="#" id="forgot-password-link">Forgot password?</a>
                    </div>
                    <div class="register-link">
                        Don't have an account? <a href="#" id="register-link">Register here</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Register</h2>
                <span class="close" id="close-register-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form autocomplete="on">
                    <div class="form-group">
                        <label for="register-first-name">First Name:</label>
                        <input type="text" id="register-first-name" name="first-name" placeholder="Enter your first name" required autocomplete="given-name">
                    </div>
                    <div class="form-group">
                        <label for="register-last-name">Last Name:</label>
                        <input type="text" id="register-last-name" name="last-name" placeholder="Enter your last name" required autocomplete="family-name">
                    </div>
                    <div class="form-group">
                        <label for="register-email">Email:</label>
                        <input type="email" id="register-email" name="email" placeholder="Enter your email" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="register-password">Password:</label>
                        <div class="password-input-group">
                            <input type="password" id="register-password" name="password" placeholder="Enter your password" required autocomplete="new-password">
                            <button type="button" id="generate-password-btn" class="btn-generate">Generate</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="register-password-confirm">Confirm Password:</label>
                        <input type="password" id="register-password-confirm" name="password-confirm" placeholder="Confirm your password" required autocomplete="new-password">
                        <div id="password-match-feedback" class="validation-message"></div>
                    </div>
                    <button type="button" id="register-submit" class="btn-primary">Register</button>
                    <div class="register-link">
                        Already have an account? <a href="#" id="login-link">Login here</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reset Password</h2>
                <span class="close" id="close-forgot-password-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>Enter your email address and we'll send you a link to reset your password.</p>
                <form autocomplete="on">
                    <div class="form-group">
                        <label for="forgot-email">Email:</label>
                        <input type="email" id="forgot-email" name="email" placeholder="Enter your email" required autocomplete="email">
                    </div>
                    <button type="button" id="forgot-submit" class="btn-primary">Send Reset Link</button>
                    <div class="register-link">
                        Remember your password? <a href="#" id="back-to-login-link">Back to login</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

    <!-- Environment variables -->
    <script>
        window.ENV = {
            AGENT_WS_BASE: "{{ agent_ws_base }}",
            AGENT_URL: "{{ agent_url }}",
            AGENT_BASE: "{{ agent_base }}",
            API_BASE: "{{ api_base }}",
            API_ASSET_URL: "{{ api_asset_url }}",
            API_NEIGHBOR_URL: "{{ api_neighbor_url }}",
            API_NAME_URL: "{{ api_name_url }}",
            API_ID_URL: "{{ api_id_url }}",
            SEMANTIC_BASE: "{{ semantic_base }}",
            SEMANTIC_EMB_URL: "{{ semantic_emb_url }}",
            SEMANTIC_RANK_URL: "{{ semantic_rank_url }}",
            SEMANTIC_SEARCH_URL: "{{ semantic_search_url }}"
        };
    </script>

    <script src="{{ url_for('static', path='/js/app.js') }}"></script>
    <script src="{{ url_for('static', path='/js/ask-agent.js') }}"></script>

    <!-- Lookup Service Modules -->
    <script src="{{ url_for('static', path='/js/lookup/asset-search.js') }}"></script>
    <script src="{{ url_for('static', path='/js/lookup/asset-info.js') }}"></script>
    <script src="{{ url_for('static', path='/js/lookup/neighbor-search.js') }}"></script>
    <script src="{{ url_for('static', path='/js/lookup/semantic-search.js') }}"></script>
    <script src="{{ url_for('static', path='/js/lookup-service.js') }}"></script>
    
    <!-- Simple Login & Register Modal Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginModal = document.getElementById('login-modal');
            const registerModal = document.getElementById('register-modal');
            const forgotPasswordModal = document.getElementById('forgot-password-modal');
            const loginBtn = document.getElementById('login-btn');
            const closeLoginModal = document.getElementById('close-login-modal');
            const closeRegisterModal = document.getElementById('close-register-modal');
            const closeForgotPasswordModal = document.getElementById('close-forgot-password-modal');
            const registerLink = document.getElementById('register-link');
            const loginLink = document.getElementById('login-link');
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const backToLoginLink = document.getElementById('back-to-login-link');
            const generatePasswordBtn = document.getElementById('generate-password-btn');
            const registerPasswordInput = document.getElementById('register-password');
            const registerPasswordConfirmInput = document.getElementById('register-password-confirm');
            const passwordMatchFeedback = document.getElementById('password-match-feedback');
            const loginEmailInput = document.getElementById('login-email');
            const forgotEmailInput = document.getElementById('forgot-email');
            
            // Open login modal when login icon is clicked
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    loginModal.style.display = 'block';
                });
            }
            
            // Open register modal when register link is clicked
            if (registerLink) {
                registerLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    loginModal.style.display = 'none';
                    registerModal.style.display = 'block';
                });
            }
            
            // Open login modal when login link is clicked (from register modal)
            if (loginLink) {
                loginLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    registerModal.style.display = 'none';
                    loginModal.style.display = 'block';
                });
            }
            
            // Open forgot password modal when forgot password link is clicked
            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Copy email from login field if it exists
                    if (loginEmailInput.value && forgotEmailInput) {
                        forgotEmailInput.value = loginEmailInput.value;
                    }
                    loginModal.style.display = 'none';
                    forgotPasswordModal.style.display = 'block';
                });
            }
            
            // Open login modal when back to login link is clicked (from forgot password modal)
            if (backToLoginLink) {
                backToLoginLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    forgotPasswordModal.style.display = 'none';
                    loginModal.style.display = 'block';
                });
            }
            
            // Close login modal when X is clicked
            if (closeLoginModal) {
                closeLoginModal.addEventListener('click', () => {
                    loginModal.style.display = 'none';
                });
            }
            
            // Close register modal when X is clicked
            if (closeRegisterModal) {
                closeRegisterModal.addEventListener('click', () => {
                    registerModal.style.display = 'none';
                });
            }
            
            // Close forgot password modal when X is clicked
            if (closeForgotPasswordModal) {
                closeForgotPasswordModal.addEventListener('click', () => {
                    forgotPasswordModal.style.display = 'none';
                });
            }
            
            // Note: Removed click outside to close functionality to keep modals stable
            
            // Close modals with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (loginModal.style.display === 'block') {
                        loginModal.style.display = 'none';
                    }
                    if (registerModal.style.display === 'block') {
                        registerModal.style.display = 'none';
                    }
                    if (forgotPasswordModal.style.display === 'block') {
                        forgotPasswordModal.style.display = 'none';
                    }
                }
            });
            
            // Password generation function
            function generatePassword() {
                const length = 12;
                const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
                let password = "";
                
                // Ensure at least one character from each type
                const lowercase = "abcdefghijklmnopqrstuvwxyz";
                const uppercase = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                const numbers = "0123456789";
                const symbols = "!@#$%^&*";
                
                password += lowercase[Math.floor(Math.random() * lowercase.length)];
                password += uppercase[Math.floor(Math.random() * uppercase.length)];
                password += numbers[Math.floor(Math.random() * numbers.length)];
                password += symbols[Math.floor(Math.random() * symbols.length)];
                
                // Fill the rest randomly
                for (let i = 4; i < length; i++) {
                    password += charset[Math.floor(Math.random() * charset.length)];
                }
                
                // Shuffle the password
                return password.split('').sort(() => Math.random() - 0.5).join('');
            }
            
            // Generate password button click handler
            if (generatePasswordBtn && registerPasswordInput) {
                generatePasswordBtn.addEventListener('click', () => {
                    const newPassword = generatePassword();
                    registerPasswordInput.value = newPassword;
                    registerPasswordInput.type = 'text'; // Show password briefly
                    
                    // Hide password after 2 seconds
                    setTimeout(() => {
                        registerPasswordInput.type = 'password';
                    }, 2000);
                });
            }
            
            // Password confirmation validation
            function validatePasswordMatch() {
                if (!registerPasswordInput || !registerPasswordConfirmInput || !passwordMatchFeedback) return;
                
                const password = registerPasswordInput.value;
                const confirmPassword = registerPasswordConfirmInput.value;
                
                // Clear feedback if confirm field is empty
                if (!confirmPassword) {
                    passwordMatchFeedback.textContent = '';
                    passwordMatchFeedback.className = 'validation-message';
                    return;
                }
                
                // Check if passwords match
                if (password === confirmPassword) {
                    passwordMatchFeedback.textContent = '✓ Passwords match';
                    passwordMatchFeedback.className = 'validation-message success';
                } else {
                    passwordMatchFeedback.textContent = '✗ Passwords do not match';
                    passwordMatchFeedback.className = 'validation-message error';
                }
            }
            
            // Add event listeners for password validation
            if (registerPasswordInput && registerPasswordConfirmInput) {
                registerPasswordInput.addEventListener('input', validatePasswordMatch);
                registerPasswordConfirmInput.addEventListener('input', validatePasswordMatch);
                
                // Also validate when password is generated
                if (generatePasswordBtn) {
                    generatePasswordBtn.addEventListener('click', () => {
                        // Small delay to ensure password is set first
                        setTimeout(validatePasswordMatch, 10);
                    });
                }
            }
        });
    </script>
</body>
</html>

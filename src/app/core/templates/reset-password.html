<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - {{ organisation_name }}</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <link rel="stylesheet" href="/static/css/auth.css">
</head>
<body>
    <div class="auth-page">
        <div class="auth-container">
            <div class="auth-header">
                <h1>Reset Your Password</h1>
                <p>Enter your new password below</p>
            </div>

            <div id="message" class="error-message" style="display: none;"></div>

            <form id="reset-form" autocomplete="on">
                <div class="form-group">
                    <label for="new-password">New Password:</label>
                    <div class="password-input-group">
                        <div class="password-field-wrapper">
                            <input type="password" id="new-password" name="new-password" placeholder="Enter your new password" required autocomplete="new-password" maxlength="255">
                            <button type="button" id="toggle-new-password" class="btn-toggle-password">
                                <img src="/static/icons/eye.svg" alt="Show password" class="eye-icon">
                            </button>
                        </div>
                        <button type="button" id="generate-password-btn" class="btn-generate">Generate</button>
                    </div>
                    <div id="password-strength-indicator" class="password-strength">
                        <div class="strength-bar">
                            <div class="strength-fill"></div>
                        </div>
                        <div class="strength-text"></div>
                    </div>
                    <div class="password-requirements">
                        Must be at least 8 characters long
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirm-password">Confirm New Password:</label>
                    <div class="password-field-wrapper">
                        <input type="password" id="confirm-password" name="confirm-password" placeholder="Confirm your new password" required autocomplete="new-password" maxlength="255">
                        <button type="button" id="toggle-confirm-password" class="btn-toggle-password">
                            <img src="/static/icons/eye.svg" alt="Show password" class="eye-icon">
                        </button>
                    </div>
                    <div id="password-match-feedback" class="validation-message"></div>
                </div>

                <button type="submit" id="reset-button" class="btn-primary">
                    Reset Password
                </button>
            </form>

            <div class="register-link">
                <a href="/">← Back to Login</a>
            </div>
        </div>
    </div>

    <script>
        class ResetPassword {
            constructor() {
                this.initializeElements();
                this.setupEventListeners();
                this.extractToken();
            }

            initializeElements() {
                this.form = document.getElementById('reset-form');
                this.newPasswordInput = document.getElementById('new-password');
                this.confirmPasswordInput = document.getElementById('confirm-password');
                this.resetButton = document.getElementById('reset-button');
                this.messageDiv = document.getElementById('message');
                this.passwordMatchFeedback = document.getElementById('password-match-feedback');
                this.toggleNewPasswordBtn = document.getElementById('toggle-new-password');
                this.toggleConfirmPasswordBtn = document.getElementById('toggle-confirm-password');
                this.generatePasswordBtn = document.getElementById('generate-password-btn');
                this.passwordStrengthIndicator = document.getElementById('password-strength-indicator');
            }

            setupEventListeners() {
                this.form.addEventListener('submit', (e) => this.handleSubmit(e));
                this.newPasswordInput.addEventListener('input', () => {
                    this.validateForm();
                    this.updatePasswordStrength();
                });
                this.confirmPasswordInput.addEventListener('input', () => this.validateForm());

                // Password toggle functionality
                if (this.toggleNewPasswordBtn) {
                    this.toggleNewPasswordBtn.addEventListener('click', () => {
                        this.togglePasswordVisibility(this.newPasswordInput, this.toggleNewPasswordBtn);
                    });
                }

                if (this.toggleConfirmPasswordBtn) {
                    this.toggleConfirmPasswordBtn.addEventListener('click', () => {
                        this.togglePasswordVisibility(this.confirmPasswordInput, this.toggleConfirmPasswordBtn);
                    });
                }

                // Password generation
                if (this.generatePasswordBtn) {
                    this.generatePasswordBtn.addEventListener('click', () => this.generatePassword());
                }
            }

            togglePasswordVisibility(inputField, toggleButton) {
                const eyeIcon = toggleButton.querySelector('.eye-icon');

                if (inputField.type === 'password') {
                    // Show password
                    inputField.type = 'text';
                    eyeIcon.src = '/static/icons/eye-off.svg';
                    eyeIcon.alt = 'Hide password';
                } else {
                    // Hide password
                    inputField.type = 'password';
                    eyeIcon.src = '/static/icons/eye.svg';
                    eyeIcon.alt = 'Show password';
                }
            }

            extractToken() {
                const urlParams = new URLSearchParams(window.location.search);
                this.token = urlParams.get('token');

                if (!this.token) {
                    this.showMessage('Invalid or missing reset token', 'auth-error');
                    this.resetButton.disabled = true;
                }
            }

            validateForm() {
                const newPassword = this.newPasswordInput.value;
                const confirmPassword = this.confirmPasswordInput.value;

                // Password match validation
                if (confirmPassword && this.passwordMatchFeedback) {
                    if (newPassword === confirmPassword) {
                        this.passwordMatchFeedback.textContent = '✓ Passwords match';
                        this.passwordMatchFeedback.className = 'validation-message success';
                    } else {
                        this.passwordMatchFeedback.textContent = '✗ Passwords do not match';
                        this.passwordMatchFeedback.className = 'validation-message error';
                    }
                } else if (this.passwordMatchFeedback) {
                    this.passwordMatchFeedback.textContent = '';
                    this.passwordMatchFeedback.className = 'validation-message';
                }

                const isValid = newPassword.length >= 8 &&
                              confirmPassword.length >= 8 &&
                              newPassword === confirmPassword;

                this.resetButton.disabled = !isValid || !this.token;

                // Update button appearance
                if (isValid && this.token) {
                    this.resetButton.classList.remove('disabled');
                } else {
                    this.resetButton.classList.add('disabled');
                }

                // Clear general error message if passwords match
                if (isValid || (!newPassword && !confirmPassword)) {
                    this.hideMessage();
                }
            }

            async handleSubmit(e) {
                e.preventDefault();

                if (!this.token) {
                    this.showMessage('Invalid reset token', 'auth-error');
                    return;
                }

                const newPassword = this.newPasswordInput.value;
                const confirmPassword = this.confirmPasswordInput.value;

                if (newPassword !== confirmPassword) {
                    this.showMessage('Passwords do not match', 'auth-error');
                    return;
                }

                if (newPassword.length < 8) {
                    this.showMessage('Password must be at least 8 characters long', 'auth-error');
                    return;
                }

                this.setLoading(true);

                try {
                    const response = await fetch('/auth/reset-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            token: this.token,
                            new_password: newPassword
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.detail || 'Password reset failed');
                    }

                    this.showMessage('Password reset successful! Redirecting to login...', 'auth-success');

                    // Redirect to login page after 2 seconds
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);

                } catch (error) {
                    this.showMessage(error.message, 'auth-error');
                } finally {
                    this.setLoading(false);
                }
            }

            showMessage(text, className) {
                this.messageDiv.textContent = text;
                this.messageDiv.className = className;
                this.messageDiv.style.display = 'block';
            }

            hideMessage() {
                this.messageDiv.style.display = 'none';
            }

            setLoading(loading) {
                this.resetButton.disabled = loading;
                this.resetButton.textContent = loading ? 'Resetting...' : 'Reset Password';
            }

            generatePassword() {
                const length = 12;
                const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
                let password = "";

                // Ensure at least one character from each type
                const lowercase = "abcdefghijklmnopqrstuvwxyz";
                const uppercase = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                const numbers = "0123456789";
                const symbols = "!@#$%^&*";

                password += lowercase[Math.floor(Math.random() * lowercase.length)];
                password += uppercase[Math.floor(Math.random() * uppercase.length)];
                password += numbers[Math.floor(Math.random() * numbers.length)];
                password += symbols[Math.floor(Math.random() * symbols.length)];

                // Fill the rest randomly
                for (let i = 4; i < length; i++) {
                    password += charset[Math.floor(Math.random() * charset.length)];
                }

                // Shuffle the password
                const shuffledPassword = password.split('').sort(() => Math.random() - 0.5).join('');

                this.newPasswordInput.value = shuffledPassword;
                this.newPasswordInput.type = 'text'; // Show password briefly

                // Hide password after 2 seconds
                setTimeout(() => {
                    this.newPasswordInput.type = 'password';
                }, 2000);

                // Update validation and strength after generation
                setTimeout(() => {
                    this.validateForm();
                    this.updatePasswordStrength();
                }, 10);
            }

            updatePasswordStrength() {
                if (!this.passwordStrengthIndicator) return;

                const password = this.newPasswordInput.value;
                const strength = this.calculatePasswordStrength(password);

                const strengthFill = this.passwordStrengthIndicator.querySelector('.strength-fill');
                const strengthText = this.passwordStrengthIndicator.querySelector('.strength-text');

                // Clear previous classes
                strengthFill.className = 'strength-fill';
                strengthText.className = 'strength-text';

                if (!password) {
                    // Empty password - hide indicator
                    strengthText.textContent = '';
                    return;
                }

                // Apply strength styling and text
                switch (strength) {
                    case 'weak':
                        strengthFill.classList.add('weak');
                        strengthText.classList.add('weak');
                        strengthText.textContent = 'Weak password';
                        break;
                    case 'medium':
                        strengthFill.classList.add('medium');
                        strengthText.classList.add('medium');
                        strengthText.textContent = 'Medium strength';
                        break;
                    case 'strong':
                        strengthFill.classList.add('strong');
                        strengthText.classList.add('strong');
                        strengthText.textContent = 'Strong password';
                        break;
                }
            }

            calculatePasswordStrength(password) {
                if (!password) return 'weak';

                const length = password.length;
                const uniqueChars = new Set(password).size;

                // Strong criteria: 12+ chars and 9+ different characters
                if (length >= 12 && uniqueChars >= 9) {
                    return 'strong';
                }

                // Medium criteria: reasonable length and variety
                if (length >= 8 && uniqueChars >= 6) {
                    return 'medium';
                }

                // Everything else is weak
                return 'weak';
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new ResetPassword();
        });
    </script>
</body>
</html>
